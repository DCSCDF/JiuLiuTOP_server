# 服务器文档

## 文件结构
server.js - 主服务器启动文件
app.js - Express应用配置文件


## 启动服务器

### 配置数据库
将Sql文件上传到mysql中,打开config文件夹下的dbconfig.js文件,修改正确的数据库配置
```
module.exports = {
    host: 'localhost', // 服务器地址
    port: 3306, // 端口
    user: 'admin', // 数据库用户名
    password: '5100', // 数据库密码
    database: 'JIuLiuTOP', // 数据库名称
    waitForConnections: true, // 当连接池无可用连接时，等待（true）还是抛错（false）
    connectionLimit: 10, // 连接池限制
    queueLimit: 0 // 最大连接请求队列限制，0 为不限制
};

```
### 启动服务器
下载依赖的库文件
```
npm i
```
安装好node（v20.15.0）后,启动服务器
```
node server.js
```


----------------------------------------------------------------------------
# 系统 API 接口文档
## 一、管理员接口
### 基础信息
- 基础URL: `/api/admin`
- 数据格式: `application/json`
- 认证方式: Token 验证（登录成功后获取）

### 1. 登录认证
#### 1.1 管理员登录
- **URL**: `/login`
- **方法**: `POST`
- **描述**: 管理员账号密码登录，成功返回 Token

##### 请求参数
| 参数名   | 类型   | 必填 | 说明           |
|----------|--------|------|----------------|
| account  | string | 是   | 管理员账号     |
| password | string | 是   | 加密后的密码   |

##### 响应示例
**成功响应 (200):**
```json
{
  "code": 200,
  "msg": "登录成功",
  "data": {
    "id": 1,
    "account": "admin",
    "img_url": "http://example.com/avatar.jpg",
    "email": "admin@example.com",
    "token": "a1b2c3d4-e5f6-7890-g1h2-i3j4k5l6m7n8"
  }
}
```

**失败响应:**
- 账号不存在 (404)
- 账号已锁定 (403)
- 密码错误 (500)
- 解密失败 (400)

##### 安全机制
1. 密码传输采用加密方式
2. 连续 5 次失败登录将锁定账号 10 分钟
3. 每次成功登录会重置失败计数

### 2. 权限验证
#### 2.1 Token 验证中间件
- **描述**: 用于验证请求的合法性，保护需要认证的接口

##### 验证流程
1. 从请求头获取 token 字段
2. 查询数据库验证 Token 有效性
3. 无效或过期 Token 返回 403 错误

##### 请求头要求
```
Authorization: Bearer <token>
```
或
```
token: <token>
```

### 3. 受保护接口
#### 3.1 获取管理员个人信息
- **URL**: `/profile`
- **方法**: `GET`
- **权限**: 需要有效 Token

##### 响应示例
```json
{
  "code": 200,
  "msg": "验证成功"
}
```

### 4. 公开接口
#### 4.1 获取管理员公开信息
- **URL**: `/public-info`
- **方法**: `GET`
- **权限**: 无需认证

##### 响应示例
```json
{
  "code": 200,
  "msg": "成功获取管理员公开信息",
  "data": [
    {
      "id": 1,
      "account": "admin",
      "img_url": "http://example.com/avatar.jpg",
      "email": "admin@example.com"
    },
    {
      "id": 2,
      "account": "user1",
      "img_url": "http://example.com/avatar2.jpg",
      "email": "user1@example.com"
    }
  ]
}
```

##### 安全说明
- 仅返回公开字段，过滤敏感信息
- 开发环境会返回详细错误信息

### 错误代码说明
| 代码 | 说明                 |
|------|----------------------|
| 200  | 请求成功             |
| 400  | 数据解密失败         |
| 401  | 未提供 Token         |
| 403  | Token 无效或账号已锁定|
| 404  | 账号不存在           |
| 500  | 服务器内部错误       |

---

## 二、博客管理 API
### 基础信息
- 基础URL: `/api/blog`
- 数据格式: `application/json`
- 认证方式: Token 验证（带 `_token` 的接口需要认证）

### 1. 博客管理接口（需认证）
#### 1.1 添加博客
- **URL**: `/_token/add`
- **方法**: `POST`
- **权限**: 需要有效 Token

##### 请求参数
| 参数名     | 类型   | 必填 | 说明           |
|------------|--------|------|----------------|
| title      | string | 是   | 博客标题       |
| categoryId | number | 是   | 分类 ID        |
| content    | string | 是   | 博客内容       |
| img_url    | string | 否   | 封面图片 URL   |

##### 响应示例
**成功响应 (200):**
```json
{
  "code": 200,
  "msg": "添加成功"
}
```

**失败响应:**
- 参数错误 (400)
- 服务器错误 (500)

#### 1.2 修改博客
- **URL**: `/_token/update`
- **方法**: `PUT`
- **权限**: 需要有效 Token

##### 请求参数
| 参数名     | 类型   | 必填 | 说明           |
|------------|--------|------|----------------|
| id         | string | 是   | 博客 ID        |
| title      | string | 是   | 博客标题       |
| categoryId | number | 是   | 分类 ID        |
| content    | string | 是   | 博客内容       |
| img_url    | string | 否   | 封面图片 URL   |

##### 响应示例
**成功响应 (200):**
```json
{
  "code": 200,
  "msg": "修改成功"
}
```

**失败响应:**
- 参数错误 (400)
- 服务器错误 (500)

#### 1.3 删除博客
- **URL**: `/_token/delete`
- **方法**: `DELETE`
- **权限**: 需要有效 Token

##### 请求参数
| 参数名 | 类型   | 必填 | 说明           |
|--------|--------|------|----------------|
| id     | string | 是   | 博客 ID        |

##### 响应示例
**成功响应 (200):**
```json
{
  "code": 200,
  "msg": "删除成功"
}
```

**失败响应:**
- 参数错误 (400)
- 服务器错误 (500)

### 2. 博客查询接口（公开）
#### 2.1 博客搜索
- **URL**: `/search`
- **方法**: `GET`
- **权限**: 无需认证

##### 请求参数
| 参数名     | 类型   | 必填 | 说明           |
|------------|--------|------|----------------|
| keyword    | string | 否   | 搜索关键词     |
| categoryId | number | 否   | 分类 ID        |
| page       | number | 否   | 页码（默认 1） |
| pageSize   | number | 否   | 每页数量（默认 10） |

##### 响应示例
**成功响应 (200):**
```json
{
  "code": 200,
  "mes": "查询成功",
  "data": {
    "keyword": "",
    "categoryId": 0,
    "page": 1,
    "pageSize": 10,
    "rows": [
      {
        "id": "123456789",
        "category_id": 1,
        "create_time": 1672531200000,
        "title": "示例博客",
        "content": "这是博客内容的摘要...",
        "img_url": "http://example.com/image.jpg"
      }
    ],
    "count": 15
  }
}
```

**失败响应:**
- 服务器错误 (500)

#### 2.2 博客详情
- **URL**: `/detail`
- **方法**: `GET`
- **权限**: 无需认证

##### 请求参数
| 参数名 | 类型   | 必填 | 说明           |
|--------|--------|------|----------------|
| id     | string | 是   | 博客 ID        |

##### 响应示例
**成功响应 (200):**
```json
{
  "code": 200,
  "mes": "获取成功",
  "data": {
    "id": "123456789",
    "category_id": 1,
    "create_time": 1672531200000,
    "title": "示例博客",
    "content": "<p>这是完整的博客内容...</p>",
    "img_url": "http://example.com/image.jpg"
  }
}
```

**失败响应:**
- 文章不存在 (404)
- 服务器错误 (500)

### 错误代码说明
| 代码 | 说明           |
|------|----------------|
| 200  | 请求成功       |
| 400  | 参数错误       |
| 404  | 文章不存在     |
| 500  | 服务器内部错误 |

---

## 三、分类管理 API
### 基础信息
- 基础URL: `/api/category`
- 数据格式: `application/json`
- 认证方式: Token 验证（带 `_token` 的接口需要认证）

### 1. 分类查询接口（公开）
#### 1.1 获取分类列表
- **URL**: `/list`
- **方法**: `GET`
- **权限**: 无需认证
- **请求参数**: 无

##### 响应示例
**成功响应 (200):**
```json
{
  "code": 200,
  "msg": "查询成功",
  "data": [
    {
      "id": "123456789",
      "name": "技术"
    },
    {
      "id": "987654321",
      "name": "生活"
    }
  ],
  "total": 2
}
```

**失败响应:**
- 服务器错误 (500)

### 2. 分类管理接口（需认证）
#### 2.1 添加分类
- **URL**: `/_token/add`
- **方法**: `POST`
- **权限**: 需要有效 Token

##### 请求参数
| 参数名 | 类型   | 必填 | 说明           |
|--------|--------|------|----------------|
| name   | string | 是   | 分类名称       |

##### 响应示例
**成功响应 (200):**
```json
{
  "code": 200,
  "msg": "添加成功"
}
```

**失败响应:**
- 参数错误 (400)
- 服务器错误 (500)

#### 2.2 修改分类
- **URL**: `/_token/update`
- **方法**: `PUT`
- **权限**: 需要有效 Token

##### 请求参数
| 参数名 | 类型   | 必填 | 说明           |
|--------|--------|------|----------------|
| id     | string | 是   | 分类 ID        |
| name   | string | 是   | 新分类名称     |

##### 响应示例
**成功响应 (200):**
```json
{
  "code": 200,
  "msg": "修改成功"
}
```

**失败响应:**
- 参数错误 (400)
- 服务器错误 (500)

#### 2.3 删除分类
- **URL**: `/_token/delete`
- **方法**: `DELETE`
- **权限**: 需要有效 Token

##### 请求参数
| 参数名 | 类型   | 必填 | 说明           |
|--------|--------|------|----------------|
| id     | string | 是   | 分类 ID        |

##### 响应示例
**成功响应 (200):**
```json
{
  "code": 200,
  "msg": "删除成功"
}
```

**失败响应:**
- 参数错误 (400)
- 服务器错误 (500)

### 错误代码说明
| 代码 | 说明           |
|------|----------------|
| 200  | 请求成功       |
| 400  | 参数错误       |
| 500  | 服务器内部错误 |

---

## 四、图片上传与管理 API（封面，不含文章内图片）
### 基础信息
- 基础URL: `/api/image`
- 数据格式: `multipart/form-data`（上传）或 `application/json`
- 认证方式: Bearer Token 验证（部分接口需要认证）

### 1. 图片上传接口（需认证）
#### 1.1 富文本编辑器图片上传
- **URL**: `/rich_editor_upload`
- **方法**: `POST`
- **权限**: 需要有效 Token
- **Content-Type**: `multipart/form-data`

##### 请求头
```
Authorization: Bearer <your_token>
```

##### 请求参数
| 参数名 | 类型 | 必填 | 说明           |
|--------|------|------|----------------|
| file   | file | 是   | 上传的图片文件 |

##### 响应示例
**成功响应 (200):**
```json
{
  "errno": 0,
  "data": {
    "url": "http://example.com/upload/123456789.jpg"
  }
}
```

**失败响应:**
- 未收到文件 (400)
- 文件类型不支持 (400)
- 服务器处理异常 (500)

##### 技术细节
1. 支持格式: JPG/JPEG/PNG/GIF/WEBP/BMP
2. 自动压缩: 最大分辨率 2560×1440，质量 75%
3. 安全处理: 生成唯一文件名，删除临时文件

### 2. 图片管理接口
#### 2.1 删除图片（需认证）
- **URL**: `/delete/:filename`
- **方法**: `DELETE`
- **权限**: 需要有效 Token

##### 请求示例
```
DELETE /api/image/delete/123456789.jpg
```

##### 响应示例
**成功响应 (200):**
```json
{
  "errno": 0,
  "message": "文件删除成功"
}
```

**失败响应:**
- 文件不存在 (404)
- 删除失败 (500)

#### 2.2 获取图片列表
- **URL**: `/images`
- **方法**: `GET`
- **权限**: 无需认证

##### 响应示例
**成功响应 (200):**
```json
{
  "errno": 0,
  "data": [
    {
      "filename": "123456789.jpg",
      "url": "http://example.com/upload/123456789.jpg"
    },
    {
      "filename": "987654321.png",
      "url": "http://example.com/upload/987654321.png"
    }
  ]
}
```

**失败响应:**
- 获取失败 (500)

### 错误代码说明
| errno | 说明                 |
|-------|----------------------|
| 0     | 操作成功             |
| 1     | 未收到文件           |
| 2     | 服务器处理异常       |
| 3     | 文件类型不支持       |
| 4     | 文件不存在           |
| 5     | 文件删除失败         |
| 6     | 获取图片列表失败     |
| 401   | 认证失败             |
| 500   | 服务器内部错误       |

### 安全规范
1. 文件验证：双重校验 MIME 类型和文件扩展名
2. 访问控制：敏感操作需 Token 认证
3. 资源清理：自动删除处理过程中的临时文件
4. 防注入：使用安全文件名生成算法
